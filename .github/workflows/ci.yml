name: CI/CD

on:
  # Trigger on pushes to branch for deployment (excluding docs)
  push:
    branches: [ main ]
    paths-ignore: 
      # Documentation files (5 files)
      - '**/*.md'         
      - 'docs/**'         
      
      # Git files 
      - '.gitignore'      
      - '.gitattributes'   
      - '.gitmodules'      
      
      # Editor/IDE configuration 
      - '.editorconfig'   

      # License files (2 files)  
      - 'LICENSE*'       
      - 'THIRD-PARTY-NOTICES.md'

  # Trigger on pull requests for validation (excluding docs)  
  pull_request:
    branches: [ main ]
    paths-ignore: 
    - '**/*.md'         
    - 'docs/**'         
      
      # Git files 
    - '.gitignore'       
    - '.gitattributes'   
    - '.gitmodules'      
      
      # Editor/IDE configuration 
    - '.editorconfig'   

      # License files (2 files)  
    - 'LICENSE*'       
    - 'THIRD-PARTY-NOTICES.md'

permissions:
  contents: write
  packages: write  # Required to push to GitHub Container Registry


env:
  TRIGGER_BRANCH: main
  CAKE_VERSION: 1.1.0  # Version of Cake to use
  
jobs:
  # Job 1: Build and Test (runs on ALL branches)
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive   # Required for version comparison

    # Setup Cake
    - name: Setup Cake
      uses: cake-build/cake-action@v3
      with:
        version: ${{env.CAKE_VERSION}}

    - name: Make build.sh executable
      run: |
        chmod +x build.sh

    # Build .NET
    - name: Build .NET
      run: |
        ./build.sh --target=Build --configuration=Release

    # Run Tests
    - name: Run Tests
      run: |
        ./build.sh --target=Test --configuration=Release

  #Job 2: Version Bump (runs only on main branch)
  version-bump:
    runs-on: ubuntu-latest
    needs: build-and-test

   # Only run on push events to main branch (not PRs or other branches)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  
    steps: 
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    
    - name: Automatic versioning 
      run: |
        MAJOR=$(jq -r '.Major' build/version.json)
        MINOR=$(jq -r '.Minor' build/version.json)
        PATCH=$(jq -r '.Patch' build/version.json)

        if [ $PATCH -eq 99 ]; then
          MINOR=$((MINOR + 1))
          PATCH=0
          jq --arg new_minor "$MINOR" --arg new_patch "0" '.Minor = ($new_minor | tonumber) | .Patch = 0' build/version.json > build/version.tmp.json
        else
          PATCH=$((PATCH + 1))
          jq --arg new_patch "$PATCH" '.Patch = ($new_patch | tonumber)' build/version.json > build/version.tmp.json
        fi

        echo "New version: $MAJOR.$MINOR.$PATCH"
        jq empty build/version.tmp.json  # Validate JSON is valid
        mv build/version.tmp.json build/version.json

        git config --global user.name "${{ github.actor }}"
        git config --global user.email "${{ github.actor }}@users.noreply.github.com"
        git add build/version.json
        git commit -m "Bump version to $MAJOR.$MINOR.$PATCH [skip ci]"
        
        # Pull any remote changes before pushing to avoid conflicts
        git pull --rebase origin ${{ env.TRIGGER_BRANCH }} --no-edit
        git push origin ${{ env.TRIGGER_BRANCH }}
        

  # Job 3: Build and Push Container (ONLY on main branch pushes)
  build-and-push-container:
    runs-on: ubuntu-latest
    needs: version-bump
    
   # Only run on push events to main branch (not PRs or other branches)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
        ref: ${{ env.TRIGGER_BRANCH }}  # Ensure we get the latest main branch with version bump

    # Setup Cake
    - name: Setup Cake
      uses: cake-build/cake-action@v3
      with:
        version: ${{ env.CAKE_VERSION }}

    - name: Make build.sh executable
      run: |
        chmod +x build.sh

    # Build .NET (required before container build)
    - name: Build .NET
      run: |
        ./build.sh --target=Build --configuration=Release

    # Login to Azure Container Registry
    - name: Log in to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.REGISTRY }}
        username: ${{ secrets.AZ_NRUUVITAG_USERNAME }}
        password: ${{ secrets.AZ_NRUUVITAG_PASS }}

    # Build Container at local 
    - name: Build and Push Container at local daemon
      run: |
        ./build.sh --target=PublishContainer --configuration=Release \
        --property="ContainerRepository=${{ secrets.IMAGE_NAME }}"
    
    - name: Extract version and tag Docker image
      run: |
        MAJOR=$(jq -r '.Major' build/version.json)
        MINOR=$(jq -r '.Minor' build/version.json)
        PATCH=$(jq -r '.Patch' build/version.json)
        VERSION="$MAJOR.$MINOR.$PATCH"
        
        echo "Tagging and pushing version: $VERSION"
        
        # Tag with version number
        docker tag ${{ secrets.IMAGE_NAME }}:$VERSION ${{ secrets.REGISTRY }}/${{ secrets.IMAGE_NAME }}:$VERSION
        
        # Push tag
        docker push ${{ secrets.REGISTRY }}/${{ secrets.IMAGE_NAME }}:$VERSION


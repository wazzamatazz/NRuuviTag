# NRuuviTag v4.0 Release Notes

## Breaking Changes

### Target Framework Changes

The target framework for the following projects has been updated from `.NET Standard 2.1` to `.NET 9`:

- [NRuuviTag.Core](../../src/NRuuviTag.Core)
- [NRuuviTag.Listener.Linux](../../src/NRuuviTag.Listener.Linux)
- [NRuuviTag.AzureEventHubs.Agent](../../src/NRuuviTag.AzureEventHubs.Agent)
- [NRuuviTag.AzureEventHubs.Mqtt](../../src/NRuuviTag.AzureEventHubs.Mqtt)
- [NRuuviTag.OpenTelemetry](../../src/NRuuviTag.OpenTelemetry)

**Impact:**
- Allows use of modern C# features such as `record` types and `init`-only properties.
- Existing applications targeting .NET Standard 2.1 will need to upgrade to .NET 9 or later to use these libraries.

### Core Type Refactoring

#### `RuuviTagSample` and `RuuviTagSampleExtended`

**Changed from `class` to `record`**

Both `RuuviTagSample` and `RuuviTagSampleExtended` have been converted from mutable classes to immutable records with `init`-only properties.

**v3.0.0:**
```csharp
public class RuuviTagSample {
    public DateTimeOffset? Timestamp { get; set; }
    public double? Temperature { get; set; }
    // ... other properties with set accessors
}

public class RuuviTagSampleExtended : RuuviTagSample {
    public string? DeviceId { get; set; }
    public string? DisplayName { get; set; }
}
```

**v4.0.0:**
```csharp
public record RuuviTagSample : RuuviDataPayload {
    public DateTimeOffset? Timestamp { get; init; }
    public double? SignalStrength { get; init; }
    // Properties inherited from RuuviDataPayload
}

public record RuuviTagSampleExtended : RuuviTagSample {
    public string? DeviceId { get; init; }
    public string? DisplayName { get; init; }
}
```

**Impact:**
- Properties can no longer be set after object construction (use `init` or constructor)
- Records provide value-based equality instead of reference equality
- Records support non-destructive mutation via `with` expressions

#### Introduction of `RuuviDataPayload`

A new base type `RuuviDataPayload` has been introduced to represent the raw sensor data payload. `RuuviTagSample` now inherits from this base type and adds sample metadata (`Timestamp` and `SignalStrength`).

**v4.0.0 Structure:**
```csharp
public record RuuviDataPayload {
    public byte? DataFormat { get; init; }
    public bool? Calibrated { get; init; }
    public double? Temperature { get; init; }
    public double? Humidity { get; init; }
    public double? Pressure { get; init; }
    // ... sensor measurement properties
    public string? MacAddress { get; init; }
}

public record RuuviTagSample : RuuviDataPayload {
    public DateTimeOffset? Timestamp { get; init; }
    public double? SignalStrength { get; init; }
}
```

**Impact:**
- Sensor data properties moved from `RuuviTagSample` to `RuuviDataPayload`
- `RuuviTagSample` now focuses on sample metadata while inheriting all sensor data properties
- Enables better separation of concerns between raw payload data and sample context

### Payload Format Support

Version 4.0 adds support for multiple Ruuvi data formats:

- **RAW v2 format** - Used by RuuviTag devices (existing support maintained)
- **Extended V1 format** - Used by the new Ruuvi Air devices (new in v4.0)

The `RuuviDataPayload` type is designed as a composite type that accommodates both formats. The `DataFormat` property indicates which format is used, and consumers can expect different properties to be populated based on the format:

- RAW v2 (RuuviTag): Traditional environmental and motion sensors
- Extended V1 (Ruuvi Air): Environmental sensors plus air quality measurements (PM, CO2, VOC, NOX, luminosity)

#### Property Type Changes

**`MeasurementSequence` type changed from `ushort?` to `uint?`**

**v3.0.0:**
```csharp
public ushort? MeasurementSequence { get; set; }
```

**v4.0.0:**
```csharp
public uint? MeasurementSequence { get; init; }
```

**Impact:**
- Supports the allowed value range for the Extended V1 data format used by Ruuvi Air, which requires a larger measurement sequence range than the RAW v2 format used by RuuviTag
- May require casting or type adjustments in code that explicitly uses `ushort`

#### Constructor Changes

**`RuuviTagSample` Constructor**

**v4.0.0 adds:**
```csharp
public RuuviTagSample(DateTimeOffset? timestamp, double? signalStrength, RuuviDataPayload payload)
```

This constructor allows creating a `RuuviTagSample` from a `RuuviDataPayload` instance.

**`RuuviTagSampleExtended` Constructor**

**v3.0.0:**
```csharp
public static RuuviTagSampleExtended Create(RuuviTagSample sample, string? deviceId, string? displayName)
```

**v4.0.0:**
```csharp
public RuuviTagSampleExtended(string? deviceId, string? displayName, RuuviTagSample sample)
```

**Impact:**
- Static factory method `Create` removed in favor of constructor
- Constructor parameter order: `deviceId`, `displayName`, `sample`

### New Sensor Properties

Support for additional Ruuvi Air quality sensor measurements has been added to `RuuviDataPayload`:

- `Calibrated` - Sensor calibration status
- `PM10` - PM 1.0 particulate matter (µg/m³)
- `PM25` - PM 2.5 particulate matter (µg/m³)
- `PM40` - PM 4.0 particulate matter (µg/m³)
- `PM100` - PM 10.0 particulate matter (µg/m³)
- `CO2` - Carbon dioxide (ppm)
- `VOC` - Volatile organic compounds index (unitless)
- `NOX` - Nitrogen oxides index (unitless)
- `Luminosity` - Light level (lux)

**Impact:**
- These properties will be `null` for RuuviTag devices that don't support these measurements
- Existing code is unaffected unless it explicitly checks for these new properties

### JSON Serialization

All properties in `RuuviDataPayload`, `RuuviTagSample`, and `RuuviTagSampleExtended` now have `[JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]` attributes, ensuring `null` values are omitted from JSON output.

**Impact:**
- Cleaner JSON output with fewer null properties
- Consumers parsing JSON should already handle optional properties correctly

## Migration Guide

### Updating Object Initialization

**Before (v3.0.0):**
```csharp
var sample = new RuuviTagSample {
    Timestamp = DateTimeOffset.UtcNow,
    Temperature = 22.5,
    MacAddress = "AA:BB:CC:DD:EE:FF"
};

sample.Temperature = 23.0; // Allowed
```

**After (v4.0.0):**
```csharp
var sample = new RuuviTagSample {
    Timestamp = DateTimeOffset.UtcNow,
    Temperature = 22.5,
    MacAddress = "AA:BB:CC:DD:EE:FF"
};

// sample.Temperature = 23.0; // Not allowed - use 'with' expression instead
var updated = sample with { Temperature = 23.0 };
```

### Updating `RuuviTagSampleExtended` Creation

**Before (v3.0.0):**
```csharp
var extended = RuuviTagSampleExtended.Create(sample, "device-001", "Living Room");
```

**After (v4.0.0):**
```csharp
var extended = new RuuviTagSampleExtended("device-001", "Living Room", sample);
```

### Working with `RuuviDataPayload`

If you need to work with raw payload data separately from sample metadata:

```csharp
// Create a payload-only instance
var payload = new RuuviDataPayload {
    DataFormat = 5,
    Temperature = 22.5,
    Humidity = 45.0,
    MacAddress = "AA:BB:CC:DD:EE:FF"
};

// Create a sample from the payload
var sample = new RuuviTagSample(DateTimeOffset.UtcNow, -65.0, payload);
```

### Handling `MeasurementSequence` Type Change

**Before (v3.0.0):**
```csharp
ushort? sequence = sample.MeasurementSequence;
```

**After (v4.0.0):**
```csharp
uint? sequence = sample.MeasurementSequence;

// If you need ushort for backward compatibility:
ushort? sequenceCompat = sample.MeasurementSequence.HasValue
    ? (ushort)sample.MeasurementSequence.Value
    : null;
```

## Summary

Version 4.0 introduces significant improvements to the core type system:

- **Immutability**: Records provide safer, more predictable code
- **Better Separation**: `RuuviDataPayload` separates sensor data from sample metadata
- **Extended Support**: New properties support Ruuvi Air quality sensors and Extended V1 format
- **Modern .NET**: Leverages record types and init-only properties

While these changes require code updates, they provide a more robust and maintainable API for working with Ruuvi sensor data.

---

*Generated with assistance from [Claude Code](https://claude.com/claude-code)*